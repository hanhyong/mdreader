<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MD Pink Mask Reader • Vanilla + Share</title>
  <!-- markdown-it (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.2/dist/markdown-it.min.js"></script>
  <!-- LZ-String for URL-safe compression -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0a; --fg: #e5e5e5; --muted: #9ca3af;
      --panel: #171717; --panel-border: #262626;
      --accent: #ffb8eb; --accent-opaque: rgba(255,184,235,1); --accent-trans: rgba(255,184,235,0.4);
      --btn-green: #059669; --btn-rose: #e11d48; --btn-blue:#2563eb;
    }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .wrap { max-width: 960px; margin: 0 auto; padding: 24px 16px 56px; }
    h1 { font-size: 24px; margin: 0 0 8px; }
    .sub { color: var(--muted); font-size: 14px; margin-bottom: 16px; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .btn { padding: 8px 12px; border-radius: 999px; border: 1px solid var(--panel-border); background:#111; color:var(--fg); cursor:pointer; }
    .btn:hover { filter: brightness(1.2); }
    .btn.green { background: var(--btn-green); border-color: transparent; }
    .btn.rose { background: var(--btn-rose); border-color: transparent; }
    .btn.blue { background: var(--btn-blue); border-color: transparent; }
    .dropzone { border:1.5px dashed var(--panel-border); color: var(--muted); border-radius: 16px; padding: 16px; margin: 12px 0; }
    .panel { background: var(--panel); border:1px solid var(--panel-border); border-radius: 16px; padding: 20px; }

    /* 마스킹 컴포넌트 */
    .mask { position: relative; display: inline-block; border-radius: 6px; cursor: pointer; padding: 0.08em 0.24em; }
    .mask:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .mask .mask-text { transition: opacity .15s ease; }
    .mask[data-hidden="1"] .mask-text { opacity: 0; }
    .mask .mask-cover { position:absolute; inset:0; border-radius:6px; transition: opacity .15s ease, background-color .15s ease; pointer-events: none; }
    .mask[data-hidden="1"] .mask-cover { background: var(--accent-opaque); }
    .mask[data-hidden="0"] .mask-cover { background: var(--accent-trans); }

    /* prose-ish */
    .content { line-height: 1.7; }
    .content { white-space: pre-wrap; }
    .content h1, .content h2, .content h3 { scroll-margin-top: 80px; }
    .content pre { background:#0f172a; color:#e5e7eb; padding:12px; border-radius:12px; overflow:auto; border:1px solid #1f2937; }
    .content code { background:#111827; border:1px solid #1f2937; padding: 0 4px; border-radius: 6px; }
    .counter { margin-left:auto; color: var(--muted); font-size: 14px; }
    .muted { color: var(--muted); }
    .warn { color:#fda4af; font-size:13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>MD Pink Mask Reader (Vanilla + Share)</h1>
      <p class="sub">핑크 <code>&lt;mark style="background:#FFB8EB.."&gt;</code>만 가리기/보이기 • 링크로 저장·복원</p>
    </header>

    <div class="toolbar">
      <label class="btn" title=".md 파일 열기">
        <input id="file-input" type="file" accept=".md,.markdown,.txt" hidden>
        파일 열기 (.md)
      </label>
      <button class="btn" id="btn-paste">클립보드에서 붙여넣기</button>
      <button class="btn green" id="btn-show">전부 보이기</button>
      <button class="btn rose" id="btn-hide">전부 가리기</button>
      <button class="btn blue" id="btn-share">공유 링크 복사</button>
      <span class="counter">핑크 블록: <b id="pink-count">0</b></span>
    </div>

    <div class="dropzone" id="dropzone">여기에 .md 파일을 드래그 앤 드롭하세요</div>

    <section class="panel content" id="content" tabindex="-1">
      <p class="muted">.md를 열면 이 영역에 렌더링됩니다. 핑크 하이라이트(<code>&lt;mark style="background:#FFB8EBA6;"&gt;...&lt;/mark&gt;</code>)만 마스킹 대상입니다.</p>
      <p class="warn" id="url-warn" style="display:none;">⚠️ 링크가 너무 길어질 수 있어요. 가능한 한 파일을 간결하게 유지하세요.</p>
    </section>
  </div>

  <script>
    /** 상태 **/
    const state = {
      mdText: '',
      pinkCount: 0
    };

    const md = window.markdownit({ html: true, linkify: true, breaks: false });

    /** 엘리먼트 **/
    const fileInput   = document.getElementById('file-input');
    const dropzone    = document.getElementById('dropzone');
    const contentEl   = document.getElementById('content');
    const pinkCountEl = document.getElementById('pink-count');
    const urlWarnEl   = document.getElementById('url-warn');

    /** 파일 열기 **/
    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      const text = await f.text();
      loadMarkdown(text);
      fileInput.value = '';
      // 파일 열면 해시도 갱신 (즉시 공유 가능)
      updateHashFromState();
    });

    /** 드롭 **/
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); });
    dropzone.addEventListener('drop', async (e) => {
      e.preventDefault();
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;
      const text = await f.text();
      loadMarkdown(text);
      updateHashFromState();
    });

    /** 클립보드 붙여넣기 **/
    document.getElementById('btn-paste').addEventListener('click', async () => {
      try {
        const text = await navigator.clipboard.readText();
        if (text) {
          loadMarkdown(text);
          updateHashFromState();
        }
      } catch (err) {
        alert('클립보드 읽기 권한이 거부되었습니다. 브라우저 설정을 확인하세요.');
      }
    });

    /** 전부 보이기/가리기 **/
    document.getElementById('btn-show').addEventListener('click', () => setAllMasks(false));
    document.getElementById('btn-hide').addEventListener('click', () => setAllMasks(true));

    /** 공유 링크 복사 **/
    document.getElementById('btn-share').addEventListener('click', async () => {
      try {
        const url = updateHashFromState();
        await navigator.clipboard.writeText(url);
        alert('공유 링크를 클립보드에 복사했습니다!');
      } catch (e) {
        // 일부 환경에서 clipboard API가 불가할 수 있음
        prompt('복사할 링크입니다. 수동으로 복사하세요:', updateHashFromState());
      }
    });

    /** 렌더 + 마스킹 **/
    function loadMarkdown(text){
      state.mdText = text || '';
      const html = md.render(state.mdText);
      contentEl.innerHTML = html;
      applyPinkMasks(contentEl);
      contentEl.focus({preventScroll:false});
    }

    function isPinkMark(node){
      if (!node || node.tagName !== 'MARK') return false;
      const style = (node.getAttribute('style') || '').toLowerCase().replace(/\s+/g,'');
      return style.includes('#ffb8eb'); // #FFB8EB..만 대상
    }

    function wrapWithMask(markEl){
      const wrapper = document.createElement('span');
      wrapper.className = 'mask';
      wrapper.setAttribute('data-hidden', '1');
      wrapper.setAttribute('role', 'button');
      wrapper.setAttribute('tabindex', '0');
      wrapper.setAttribute('title', '클릭해 보기');

      const textSpan = document.createElement('span');
      textSpan.className = 'mask-text';
      while(markEl.firstChild){ textSpan.appendChild(markEl.firstChild); }

      const cover = document.createElement('span');
      cover.className = 'mask-cover';
      cover.setAttribute('aria-hidden', 'true');

      wrapper.appendChild(textSpan);
      wrapper.appendChild(cover);

      wrapper.addEventListener('click', () => toggleMask(wrapper));
      wrapper.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleMask(wrapper); }
      });

      markEl.replaceWith(wrapper);
    }

    function toggleMask(wrapper){
      const hidden = wrapper.getAttribute('data-hidden') === '1';
      wrapper.setAttribute('data-hidden', hidden ? '0' : '1');
      wrapper.setAttribute('title', hidden ? '클릭해 가리기' : '클릭해 보기');
    }

    function applyPinkMasks(root){
      const marks = Array.from(root.querySelectorAll('mark'));
      let count = 0;
      marks.forEach(m => { if (isPinkMark(m)) { wrapWithMask(m); count++; }});
      state.pinkCount = count;
      pinkCountEl.textContent = String(count);
    }

    function setAllMasks(hide){
      const masks = contentEl.querySelectorAll('.mask');
      masks.forEach(el => el.setAttribute('data-hidden', hide ? '1' : '0'));
    }

    /** URL 해시 인코딩/디코딩 **/
    function buildUrlWithHash(encoded){
      // 현재 페이지의 base URL + #md=ENC
      const { origin, pathname, search } = window.location;
      return `${origin}${pathname}${search}#md=${encoded}`;
    }

    function updateHashFromState(){
      // 텍스트가 없으면 해시 제거
      if (!state.mdText) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
        return window.location.href;
      }
      // 압축 + URL-safe 인코딩
      const enc = LZString.compressToEncodedURIComponent(state.mdText);
      const url = buildUrlWithHash(enc);

      // URL 길이 경고(대략 2k 이상이면 일부 환경에서 위험)
      const tooLong = url.length > 2000;
      urlWarnEl.style.display = tooLong ? 'block' : 'none';

      // 히스토리 교체(뒤로가기 더럽히지 않음)
      history.replaceState(null, '', url);
      return url;
    }

    function tryLoadFromHash(){
      const hash = window.location.hash || '';
      const m = hash.match(/[#&]md=([^&]+)/);
      if (!m) return false;
      try {
        const dec = LZString.decompressFromEncodedURIComponent(m[1]);
        if (typeof dec === 'string' && dec.length >= 0) {
          loadMarkdown(dec);
          return true;
        }
      } catch (e) {
        console.warn('해시 복원 실패:', e);
      }
      return false;
    }

    /** 초기 로드: 해시에 md가 있으면 그걸 로드, 없으면 데모 표시 **/
    const demo = `# 데모

일반 텍스트와 <mark style="background: #FFB8EBA6;">핑크 하이라이트</mark>는 다르게 처리됩니다.

- 이건 보통 강조 ==markdown-it-mark가 아니라== HTML <mark> 태그를 사용한 경우만 마스킹 대상이에요.
- 다른 색상 <mark style="background: #d2b3ff;">보라</mark>는 가리지 않습니다.

공유 테스트: 이 페이지에서 **공유 링크 복사**를 누른 다음, 링크를 열어보세요. 같은 내용이 자동으로 복원됩니다.`;

    if (!tryLoadFromHash()) {
      loadMarkdown(demo);
      updateHashFromState(); // 데모도 공유 가능하게
    }

    /** 해시 변경(외부에서 링크 조작 시) **/
    window.addEventListener('hashchange', () => {
      tryLoadFromHash();
    });
  </script>
</body>
</html>


